#### 一、Redis 缓存回收机制

（1）数据过期： 

 ①定时删除策略：Redis 启动一个定时器监控所有的 key,一旦有过期的话就进行删除（遍历 

 所有key,非常耗费 CPU） 

 ②惰性删除策略：获取 key 的时候判断是否过期， 过期则进行删除 

 Redis 采用的方式:①(随机抓取一部分 key 进行检测)+②

（2）内存淘汰： 

 ①noeviction：当内存不足以容纳新写入数据时，新写入操作会报错。（Redis 默认策略） 

 ②allkeys-lru：当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的 Key。 

 （LRU 推荐使用） 

 ③allkeys-random：当内存不足以容纳新写入数据时，在键空间中，随机移除某个 Key。 

 ④volatile-lru：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，移除最近 

 最少使用的Key。这种情况一般是把 Redis 既当缓存，又做持久化存储的时候才用。 

 ⑤volatile-random：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，随机 

 移除某个Key。 

 ⑥volatile-ttl：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，有更早过 

 期时间的Key 优先移除。不推荐。如果没有对应的键，则回退到 noeviction 策略。



#### 二、Redis 主从同步

（1）主从复制作用

①数据冗余

②故障恢复（服务冗余）

③负载均衡

④读写分离（主节点写操作、从节点读操作）

（2）主从复制过程 

 ①连接建立阶段 

 步骤1：保存主节点信息 

 步骤2：建立 socket 连接 

 步骤3：发送 ping 命令 

 步骤4：身份验证 

 步骤5：发送从节点端口信息 

 ②数据同步阶段 

 从节点向主节点发送psync 命令 

 根据主从节点当前状态的不同，可以分为全量复制和部分复制 

 ③命令传播阶段 

 主从节点进入命令传播阶段；在这个阶段主节点将自己执行的写命令发送给从节点，从节点 

 接收命令并执行，从而保证主从节点数据的一致性。

（3）介绍全量复制和部分复制 

 ①全量复制：用于初次复制或其他无法进行部分复制的情况，将主节点中的所有数据都发送 

 给从节点，是一个非常重型的操作。 

 ②部分复制：用于网络中断等情况后的复制，只将中断期间主节点执行的写命令发送给从节 

 点，与全量复制相比更加高效。需要注意的是，如果网络中断时间过长，导致主节点没有能 

 够完整地保存中断期间执行的写命令，则无法进行部分复制，仍使用全量复制。 

 （4）主从复制缺点：故障恢复无法自动化；写操作无法负载均衡；存储能力受到单机的限 

 制。



#### 三、为什么会有哨兵机制？

在主从复制的基础上，哨兵实现了自动化的故障恢复。



#### 四、哨兵机制作用？

（1）监控（Monitoring）：哨兵会不断地检查主节点和从节点是否运作正常。 

 （2）自动故障转移（Automatic failover）：当主节点不能正常工作时，哨兵会开始自动故障 

 转移操作，它会将失效主节点的其中一个从节点升级为新的主节点，并让其他从节点改为复 

 制新的主节点。 

 （3）配置提供者（Configuration provider）：[客户端]()在初始化时，通过连接哨兵来获得当前 

 Redis 服务的主节点地址。 

 （4）通知（Notification）：哨兵可以将故障转移的结果发送给[客户端]()。



####五、哨兵机制节点组成

它由两部分组成，哨兵节点和数据节点：

（1）哨兵节点：哨兵系统由一个或多个哨兵节点组成，哨兵节点是特殊的 [redis](https://www.nowcoder.com/jump/super-jump/word?word=redis) 节点，不存储数据。

（2）数据节点：主节点和从节点都是数据节点。



####六、哨兵机制原理

（1）定时任务：每个哨兵节点维护了 3 个定时任务。定时任务的功能分别如下：通过向主 从节点发送info 命令获取最新的主从结构；通过发布订阅功能获取其他哨兵节点的信息； 通过向其他节点发送ping 命令进行心跳检测，判断是否下线。 

 （2）主观下线：在心跳检测的定时任务中，如果其他节点超过一定时间没有回复，哨兵节 点就会将其进行主观下线。顾名思义，主观下线的意思是一个哨兵节点“主观地”判断下线； 与主观下线相对应的是客观下线。 

 （3 ） 客 观 下 线 ： 哨 兵 节 点 在 对 主 节 点 进 行 主 观 下 线 后 ， 会 通 过 sentinel is-master-down-by-addr 命令询问其他哨兵节点该主节点的状态；如果判断主节点下线的哨兵数量达到一定数值，则对该主节点进行客观下线。 

 （4）选举领导者哨兵节点：当主节点被判断客观下线以后，各个哨兵节点会进行协商，选 举出一个领导者哨兵节点，并由该领导者节点对其进行故障转移操作。监视该主节点的所有 哨兵都有可能被选为领导者，选举使用的[算法]()是Raft [算法]()；Raft [算法]()的基本思路是先到先 得：即在一轮选举中，哨兵A 向 B 发送成为领导者的申请，如果 B 没有同意过其他哨兵， 

 则会同意A 成为领导者。选举的具体过程这里不做详细描述，一般来说，哨兵选择的过程 很快，谁先完成客观下线，一般就能成为领导者。 

 （5）故障转移：选举出的领导者哨兵，开始进行故障转移操作，该操作大体可以分为 3 个  步骤： 

 ①在从节点中选择新的主节点：选择的原则是，首先过滤掉不健康的从节点；然后选择优先 级最高的从节点(由 slave-priority 指定)；如果优先级无法区分，则选择复制偏移量最大的从 节点；如果仍无法区分，则选择runid 最小的从节点。 

 ②更新主从状态：通过 slaveof no one 命令，让选出来的从节点成为主节点；并通过 slaveof 命令让其他节点成为其从节点。 

 ③将已经下线的主节点(即 6379)设置为新的主节点的从节点，当 6379 重新上线后，它会成 为新的主节点的从节点。



#### 七、哨兵机制缺点

写操作无法负载均衡；存储能力受到单机的限制。（Redis 集群解决了该情况）

#### 八、分布式缓存读写不一致问题



#### 九、一致性Hash性质

平衡性：指哈希的结果尽可能分布到所有的缓冲去，这样可以使得所有的缓冲空间都得到利用

单调性：当新的内容加入进来时，哈希的结果应该能够保证原有已分配的内容可以被映射到新的缓冲区中去，而不会被映射到旧的缓冲集合中的其他缓冲区。（线性哈希无法满足单调性）

分散性：指相同的内容可能被不同的终端映射到不同的缓冲区中，这样会导致数据分散，降低了系统存储的效率。因此好的哈希算法应该能够尽量避免不一致的情况发生，也就是尽量降低分散性。

负载：负载问题实际上是从另一个角度看待分散性问题。既然不同的终端可能将相同的内容映射到不同的缓冲区中，那么对于一个特定的缓冲区而言，也可能被不同的用户映射为不同的内容。与分散性一样，这种情况也是应当避免的，因此好的哈希算法应能够尽量降低缓冲的负荷。

平滑性：指缓存服务器的数目平滑改变和缓存对象的平滑改变是一致的。

一致性哈希算法对于节点的增减都只需要重定位环空间中的一小部分数据（西即从新增/删除节点沿着逆时针方向遇到的第一个节点之间的数据），因此具有较好的容错性和可拓展性。

#### 十、一致性哈希算法的缺点

缺点：当数据节点比较少的时候，会存在数据倾斜的情况，即大量的数据落到同一个节点上。

处理办法：增加虚拟节点，为一个真实的节点添加虚拟节点，当数据落到虚拟节点上时，再映射到真正的实际节点获取/存储数据。在实际应用中，通常将虚拟节点数设置为32甚至更大，因此即使很少的服务节点也能做到相对均匀的数据分布。